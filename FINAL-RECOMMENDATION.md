# üéØ –§–∏–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: User-Space –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ü–æ–¥—Ö–æ–¥ | Sudo-–∫–æ–º–∞–Ω–¥ | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ò–ë | –°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|--------|-------------|-----------------|---------------------|--------------|
| **1. `/opt/vault/` + sudo (—Ç–µ–∫—É—â–∏–π)** | 37 | ‚ùå –ù–µ—Ç | ‚úÖ –ì–æ—Ç–æ–≤–æ | ‚ö†Ô∏è –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
| **2. User-space vault-agent** | 7 | ‚úÖ –î–∞ | ‚ö†Ô∏è –°—Ä–µ–¥–Ω—è—è | ‚úÖ **–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø** |
| **3. Jenkins-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤** | 0 | ‚úÖ –î–∞ | ‚ùå –°–ª–æ–∂–Ω–∞—è | ‚ö†Ô∏è –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ |

---

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥: User-Space Vault-Agent

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
1. ‚úÖ **81% –º–µ–Ω—å—à–µ sudo** (7 –≤–º–µ—Å—Ç–æ 37 –∫–æ–º–∞–Ω–¥)
2. ‚úÖ **–ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ò–ë** (–≤—Å–µ –≤ `$HOME`, user units)
3. ‚úÖ **Self-service** (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–¥–º–∏–Ω–∞ –û–°)
4. ‚úÖ **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π** (mon_ci, mon_sys, mon_ro)
5. ‚úÖ **–ê–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å** (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ root)

### –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:
```bash
# 1. –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ home-–∫–∞—Ç–∞–ª–æ–≥–µ sys-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
~/monitoring/vault-agent/
  ‚îú‚îÄ‚îÄ config/   # agent.hcl, role_id.txt, secret_id.txt
  ‚îú‚îÄ‚îÄ certs/    # –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∑–¥–µ—Å—å!
  ‚îî‚îÄ‚îÄ log/      # –õ–æ–≥–∏ vault-agent

# 2. –°–æ–∑–¥–∞—Ç—å user unit
~/.config/systemd/user/vault-agent.service

# 3. Enable linger
sudo linuxadm-enable-linger CI10742292-lnx-mon_sys

# 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å
sudo -u CI10742292-lnx-mon_sys systemctl --user start vault-agent
```

### Sudo-–ø—Ä–∞–≤–∞ (—Ç–æ–ª—å–∫–æ 7!):
```
ALL=(CI10742292-lnx-mon_sys) NOEXEC: NOPASSWD: /usr/bin/systemctl --user start vault-agent.service
ALL=(CI10742292-lnx-mon_sys) NOEXEC: NOPASSWD: /usr/bin/systemctl --user stop vault-agent.service
ALL=(CI10742292-lnx-mon_sys) NOEXEC: NOPASSWD: /usr/bin/systemctl --user restart vault-agent.service
ALL=(CI10742292-lnx-mon_sys) NOEXEC: NOPASSWD: /usr/bin/systemctl --user status vault-agent.service
ALL=(CI10742292-lnx-mon_sys) NOEXEC: NOPASSWD: /usr/bin/systemctl --user is-active vault-agent.service
ALL=(CI10742292-lnx-mon_sys) NOEXEC: NOPASSWD: /usr/bin/systemctl --user enable vault-agent.service
ALL=(CI10742292-lnx-mon_sys) NOEXEC: NOPASSWD: /usr/bin/systemctl --user daemon-reload
```

---

## ‚ö†Ô∏è –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è dev

**–ü–æ–∫–∞ rights IDM –Ω–µ –≤—ã–¥–∞–Ω—ã**, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sudo —á–µ—Ä–µ–∑ `mvp_dev`:

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ install-monitoring-stack.sh
is_dev_environment() {
    case "$(hostname -f)" in
        tvlds-mvp001939*) return 0 ;;
        *) return 1 ;;
    esac
}

safe_sudo() {
    if is_dev_environment && id mvp_dev &>/dev/null; then
        sudo -u mvp_dev sudo "$@"
    else
        sudo -n "$@"
    fi
}
```

**–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤ IDM** - —É–±—Ä–∞—Ç—å —ç—Ç–æ—Ç wrapper!

---

## üìã –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (1-2 —á–∞—Å–∞)
- [ ] –ò–∑—É—á–∏—Ç—å `MIGRATION-TO-USERSPACE.md`
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–æ–≤
- [ ] –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å `agent.hcl` –¥–ª—è user-space
- [ ] –°–æ–∑–¥–∞—Ç—å user unit –¥–ª—è vault-agent

### –≠—Ç–∞–ø 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ dev (2-4 —á–∞—Å–∞)
- [ ] –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å user-space vault-agent –Ω–∞ tvlds-mvp001939
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å user-space —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

### –≠—Ç–∞–ø 3: IDM –∑–∞—è–≤–∫–∞ (1-3 –¥–Ω—è)
- [ ] –°–æ–∑–¥–∞—Ç—å IDM –∑–∞—è–≤–∫—É —Å 7 sudo-–∫–æ–º–∞–Ω–¥–∞–º–∏ (user units)
- [ ] –î–æ–∂–¥–∞—Ç—å—Å—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ prod-—Å–µ—Ä–≤–µ—Ä–∞—Ö

### –≠—Ç–∞–ø 4: Prod –¥–µ–ø–ª–æ–π (1-2 —á–∞—Å–∞)
- [ ] –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ prod —Å –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É vault-agent
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
- [ ] –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∏–∑ `/opt/vault/` (–µ—Å–ª–∏ –±—ã–ª–∏)

### –≠—Ç–∞–ø 5: Cleanup (30 –º–∏–Ω—É—Ç)
- [ ] –£–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ wrapper'—ã –¥–ª—è dev
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- [ ] –ó–∞–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫–∏ IDM –ø–æ —Å—Ç–∞—Ä—ã–º –ø—Ä–∞–≤–∞–º (–µ—Å–ª–∏ –±—ã–ª–∏)

**–ò–¢–û–ì–û: 1-2 –¥–Ω—è** (—Å —É—á–µ—Ç–æ–º —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è IDM)

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–¥–ª—è –Ω–µ—Ç–µ—Ä–ø–µ–ª–∏–≤—ã—Ö)

### –ù–∞ dev (–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å, –±–µ–∑ IDM!)

```bash
# 1. –õ–æ–≥–∏–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh CI10742292-lnx-mon_ci@tvlds-mvp001939

# 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
SYSUSER="CI10742292-lnx-mon_sys"
SYSUSER_HOME="/home/$SYSUSER"

# –°–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–µ–∑ sudo –æ—Ç mvp_dev (–≤—Ä–µ–º–µ–Ω–Ω–æ!)
sudo -u mvp_dev sudo mkdir -p "$SYSUSER_HOME/monitoring/vault-agent/"{config,certs,log}
sudo -u mvp_dev sudo mkdir -p "$SYSUSER_HOME/.config/systemd/user"
sudo -u mvp_dev sudo chown -R $SYSUSER:$SYSUSER "$SYSUSER_HOME/monitoring"
sudo -u mvp_dev sudo chmod 700 "$SYSUSER_HOME/monitoring/vault-agent/config"
sudo -u mvp_dev sudo chmod 700 "$SYSUSER_HOME/monitoring/vault-agent/certs"

# 3. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ credentials
sudo -u mvp_dev sudo cp role_id.txt secret_id.txt "$SYSUSER_HOME/monitoring/vault-agent/config/"
sudo -u mvp_dev sudo chown $SYSUSER:$SYSUSER "$SYSUSER_HOME/monitoring/vault-agent/config/"*.txt
sudo -u mvp_dev sudo chmod 600 "$SYSUSER_HOME/monitoring/vault-agent/config/"*.txt

# 4. –°–æ–∑–¥–∞–Ω–∏–µ agent.hcl
# (—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ MIGRATION-TO-USERSPACE.md)

# 5. –°–æ–∑–¥–∞–Ω–∏–µ user unit
# (—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ MIGRATION-TO-USERSPACE.md)

# 6. Enable linger
sudo -u mvp_dev sudo linuxadm-enable-linger $SYSUSER

# 7. –ó–∞–ø—É—Å–∫!
sudo -u $SYSUSER systemctl --user start vault-agent

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞
sudo -u $SYSUSER systemctl --user status vault-agent
sleep 15
sudo -u $SYSUSER ls -lah /home/$SYSUSER/monitoring/vault-agent/certs/
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `MIGRATION-TO-USERSPACE.md` | ‚≠ê –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ |
| `DEV-TEMPORARY-SUDO.md` | –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è dev —á–µ—Ä–µ–∑ mvp_dev |
| `IDM-SUDO-CLEAN.txt` | –°–ø–∏—Å–æ–∫ sudo-–ø—Ä–∞–≤ –¥–ª—è user-space (7 –∫–æ–º–∞–Ω–¥) |
| `IDM-HOWTO.md` | –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é IDM –∑–∞—è–≤–∫–∏ |
| `FINAL-RECOMMENDATION.md` | –≠—Ç–æ—Ç —Ñ–∞–π–ª ‚Äî –∏—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ |

---

## ‚ùì FAQ

### Q: –ó–∞—á–µ–º –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç?
**A:** –¢–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ —Ç—Ä–µ–±—É–µ—Ç 37 sudo-–∫–æ–º–∞–Ω–¥ –∏ **–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ò–ë**. –ò–ë –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É.

### Q: –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–π–º–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è?
**A:** –ù–∞ dev (—Å mvp_dev) ‚Äî **1-2 —á–∞—Å–∞**. –ù–∞ prod (—Å IDM) ‚Äî **1-3 –¥–Ω—è** (–æ–∂–∏–¥–∞–Ω–∏–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è).

### Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ –Ω–∞ prod?
**A:** –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è. –ò–ë —Ç—Ä–µ–±—É–µ—Ç –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ sudo –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è user-space.

### Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ vault binary –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ?
**A:** –°–∫–∞—á–∞—Ç—å –∏–∑ Nexus –∏ –ø–æ–ª–æ–∂–∏—Ç—å –≤ `~/monitoring/vault-agent/bin/vault`. –°–º. `MIGRATION-TO-USERSPACE.md`.

### Q: –ù—É–∂–Ω–æ –ª–∏ —É–¥–∞–ª—è—Ç—å /opt/vault/ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏?
**A:** –î–∞, –µ—Å–ª–∏ vault-agent –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç—É–¥–∞ —Ä–∞–Ω–µ–µ. –ù–æ —Å–Ω–∞—á–∞–ª–∞ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ user-space –≤–µ—Ä—Å–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!

### Q: –ú–æ–∂–Ω–æ –ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å vault-agent –æ—Ç mon_ci –≤–º–µ—Å—Ç–æ mon_sys?
**A:** –ú–æ–∂–Ω–æ, –Ω–æ **–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**. –ò–ë —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π: mon_ci = –¥–µ–ø–ª–æ–π, mon_sys = –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤.

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

### ü•á **–õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç**: User-Space Vault-Agent
- –ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ò–ë
- –ú–∏–Ω–∏–º—É–º sudo (7 –∫–æ–º–∞–Ω–¥)
- Self-service –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **–ù–∞—á–Ω–∏—Ç–µ —Å dev –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!**

### ü•à **–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ**: mvp_dev sudo –Ω–∞ dev
- –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∞–≤ IDM
- **–£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ user-space!**

### ü•â **–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è**: `/opt/vault/` + 37 sudo
- –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ò–ë
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
- **–ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ!**

---

## üìû –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–°–µ–≥–æ–¥–Ω—è**: –ü—Ä–æ—á–∏—Ç–∞—Ç—å `MIGRATION-TO-USERSPACE.md`
2. **–ó–∞–≤—Ç—Ä–∞**: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ dev (tvlds-mvp001939)
3. **–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é**: –°–æ–∑–¥–∞—Ç—å IDM –∑–∞—è–≤–∫—É (7 –∫–æ–º–∞–Ω–¥!)
4. **–ß–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏**: –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ prod

**–£–¥–∞—á–∏! üöÄ**
