# üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é IDM –∑–∞—è–≤–∫–∏ –¥–ª—è sudo-–ø—Ä–∞–≤

## 1Ô∏è‚É£ –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** `CI10742292-lnx-mon_ci`  
**–°–µ—Ä–≤–µ—Ä:** `tvlds-mvp001939.ca.sbrf.ru`  
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è monitoring stack —Å vault-agent  
**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∞–≤:** 37

---

## 2Ô∏è‚É£ –§–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞ –ø—Ä–∞–≤ –≤ IDM

### ‚ö†Ô∏è –í–ê–ñ–ù–û:
1. **–õ–æ–≥–∏–Ω –ù–ï —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏** (—Å–∏—Å—Ç–µ–º–∞ IDM –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
2. **–ö–∞–∂–¥–æ–µ –ø—Ä–∞–≤–æ –≤–≤–æ–¥–∏—Ç—Å—è –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ**
3. **–î–≤–æ–µ—Ç–æ—á–∏—è –≤ `chown` –∫–æ–º–∞–Ω–¥–∞—Ö —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è –æ–±—Ä–∞—Ç–Ω—ã–º —Å–ª—ç—à–µ–º** (`\:`)

### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
```
CI10742292-lnx-mon_ci ALL=(root) NOEXEC: NOPASSWD: /usr/bin/systemctl restart vault-agent
```

### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
```
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/systemctl restart vault-agent
```

---

## 3Ô∏è‚É£ –°–ø–∏—Å–æ–∫ –ø—Ä–∞–≤ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

üìÑ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª:** `IDM-SUDO-CLEAN.txt`

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç **37 —Å—Ç—Ä–æ–∫** ‚Äî –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É –Ω—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –≤ IDM –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–æ–µ sudo-–ø—Ä–∞–≤–∏–ª–æ.

---

## 4Ô∏è‚É£ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤ (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)

### –ë–ª–æ–∫ 1: User-—é–Ω–∏—Ç—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (18 –ø—Ä–∞–≤)
```
ALL=(CI10742292-lnx-mon_sys) NOEXEC: NOPASSWD: /usr/bin/systemctl --user ...
```
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏ Prometheus, Grafana, Harvest –æ—Ç –∏–º–µ–Ω–∏ sys-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

### –ë–ª–æ–∫ 2: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (3 –ø—Ä–∞–≤–∞)
```
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/cp /tmp/vault_role_id.txt /opt/vault/conf/role_id.txt
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/cp /tmp/vault_secret_id.txt /opt/vault/conf/secret_id.txt
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/cp /home/CI10742292-lnx-mon_ci/monitoring/config/vault/agent.hcl /opt/vault/conf/agent.hcl
```
–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ credentials –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ vault-agent.

---

### –ë–ª–æ–∫ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (3 –ø—Ä–∞–≤–∞)
```
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/chown CI10742292-lnx-va-start\:CI10742292-lnx-va-read /opt/vault/conf/role_id.txt
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/chown CI10742292-lnx-va-start\:CI10742292-lnx-va-read /opt/vault/conf/secret_id.txt
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/chown CI10742292-lnx-va-start\:CI10742292-lnx-va-read /opt/vault/conf/agent.hcl
```
‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï:** –î–≤–æ–µ—Ç–æ—á–∏–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: `\:`

---

### –ë–ª–æ–∫ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ (3 –ø—Ä–∞–≤–∞)
```
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/chmod 640 /opt/vault/conf/role_id.txt
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/chmod 640 /opt/vault/conf/secret_id.txt
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/chmod 640 /opt/vault/conf/agent.hcl
```
–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ 640 –¥–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.

---

### –ë–ª–æ–∫ 5: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ (3 –ø—Ä–∞–≤–∞)
```
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/mkdir -p /opt/vault/certs
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/chown CI10742292-lnx-va-start\:CI10742292-lnx-va-read /opt/vault/certs
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/chmod 750 /opt/vault/certs
```
‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï:** –î–≤–æ–µ—Ç–æ—á–∏–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: `\:`

---

### –ë–ª–æ–∫ 6: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ vault-agent (7 –ø—Ä–∞–≤)
```
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/systemctl restart vault-agent
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/systemctl status vault-agent
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/systemctl is-active vault-agent
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/systemctl start vault-agent
ALL=(root) NOEXEC: NOPASSWD: /usr/bin/systemctl stop vault-agent
```
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º vault-agent.

---

## 5Ô∏è‚É£ –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –¥–ª—è –ò–ë

### üîí –ú–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

#### ‚úÖ NOEXEC —Ñ–ª–∞–≥
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ shell escapes
- –ö–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–Ω—ä–µ–∫—Ü–∏–∏

#### ‚úÖ NOPASSWD —Ñ–ª–∞–≥
- –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ CI/CD
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏

#### ‚úÖ –Ø–≤–Ω—ã–µ –ø—É—Ç–∏ (–±–µ–∑ wildcards)
- –í—Å–µ –ø—É—Ç–∏ —É–∫–∞–∑–∞–Ω—ã —è–≤–Ω–æ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `*` –∏–ª–∏ `?`
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤: `/tmp/vault_role_id.txt`, `/tmp/vault_secret_id.txt`
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥–º–µ–Ω—É —Ñ–∞–π–ª–æ–≤ –∏ race conditions

#### ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å **—Ç–æ–ª—å–∫–æ** —É–∫–∞–∑–∞–Ω–Ω—ã–µ 37 –∫–æ–º–∞–Ω–¥
- –ù–µ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –¥—Ä—É–≥–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø—É least privilege

#### ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
- User-—é–Ω–∏—Ç—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –æ—Ç `CI10742292-lnx-mon_sys`
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ—Ç `root`
- –§–∞–π–ª—ã vault-agent –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç `CI10742292-lnx-va-start:CI10742292-lnx-va-read`

---

## 6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è IDM

–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ sudo –¥–ª—è user-—é–Ω–∏—Ç–æ–≤
sudo -n -u CI10742292-lnx-mon_sys /usr/bin/systemctl --user status monitoring-prometheus.service

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ sudo –¥–ª—è vault-agent
sudo -n /usr/bin/systemctl status vault-agent

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ sudo –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
echo "test" > /tmp/vault_role_id.txt
sudo -n /usr/bin/cp /tmp/vault_role_id.txt /opt/vault/conf/role_id.txt
rm /tmp/vault_role_id.txt

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ sudo –¥–ª—è chown (—Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
sudo -n /usr/bin/chown CI10742292-lnx-va-start:CI10742292-lnx-va-read /opt/vault/conf/role_id.txt
```

–ï—Å–ª–∏ –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è **–±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è** ‚Äî –ø—Ä–∞–≤–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ! ‚úÖ

---

## 7Ô∏è‚É£ –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤

- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `IDM-REQUEST-SUDO.md`
- **–ü—Ä–∏–º–µ—Ä sudoers:** `sudoers.example`
- **–ß–∏—Å—Ç—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∞–≤:** `IDM-SUDO-CLEAN.txt`
- **–ü–æ–¥—Ä–æ–±–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏:** `IDM-SUDO-FINAL.txt`

---

## üìù Checklist –¥–ª—è IDM –∑–∞—è–≤–∫–∏

- [ ] –£–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `CI10742292-lnx-mon_ci`
- [ ] –£–∫–∞–∑–∞—Ç—å —Å–µ—Ä–≤–µ—Ä: `tvlds-mvp001939.ca.sbrf.ru`
- [ ] –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å 37 —Å—Ç—Ä–æ–∫ –∏–∑ `IDM-SUDO-CLEAN.txt`
- [ ] –ö–∞–∂–¥–æ–µ –ø—Ä–∞–≤–æ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–≤–æ–µ—Ç–æ—á–∏–π: `\:`
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ (—Å–º. —Ä–∞–∑–¥–µ–ª 5)
- [ ] –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É (—Å–º. —Ä–∞–∑–¥–µ–ª 6)
