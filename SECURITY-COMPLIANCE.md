# SECURITY-COMPLIANCE.md
## –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** 4.0.0 - Secure Edition  
**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞—É–¥–∏—Ç–∞:** 2026-01-30  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ò–ë

---

## –†–µ–∑—é–º–µ

–ü—Ä–æ–µ–∫—Ç **Monitoring Stack Automation - Secure Edition** –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è **100% —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è** —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±–∞–Ω–∫–∞. –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã, –≤–Ω–µ–¥—Ä–µ–Ω—ã –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

---

## 1. –£—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è –ò–ë

### ‚ùå –ë—ã–ª–æ (v3.x - Legacy)
1. **–®–∏—Ä–æ–∫–∏–µ sudo –ø—Ä–∞–≤–∞**: `ALL=(ALL:ALL) NOEXEC: NOPASSWD: /bin/bash script.sh`
2. **Eval curl —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏**: `eval "curl -u ${user}:${pass} ..."`
3. **–°–µ–∫—Ä–µ—Ç—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö**: `password=$(jq -r '.pass' file)` –±–µ–∑ `unset`
4. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ bash –≤ sudoers**: –ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø–æ –¢–∞–±–ª–∏—Ü–µ 3
5. **Wildcard –≤ sudoers**: `/usr/local/bin/wrappers/*.sh` - –∑–∞–ø—Ä–µ—â–µ–Ω–æ
6. **Fallback –Ω–∞ system units**: –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–µ—Ç–æ–¥–∏—á–∫–µ SberInfra
7. **Runuser —Ç—Ä–µ–±—É–µ—Ç sudo root**: –ò–∑–±—ã—Ç–æ—á–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏
8. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ linger**: User units –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏ logout

### ‚úÖ –°—Ç–∞–ª–æ (v4.0 - Secure Edition)
1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞**: –¢–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ `systemctl --user` –∫–æ–º–∞–Ω–¥—ã –¥–ª—è CI ‚Üí sys
2. **–í—Å–µ curl —á–µ—Ä–µ–∑ –æ–±–µ—Ä—Ç–∫–∏**: –ù–∏–∫–∞–∫–∏—Ö eval, —Ç–æ–ª—å–∫–æ `grafana-api-wrapper_launcher.sh`
3. **–°–µ–∫—Ä–µ—Ç—ã —á–µ—Ä–µ–∑ wrapper**: `secrets-manager-wrapper.sh` —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º `unset`
4. **–ó–∞–ø—É—Å–∫ –ë–ï–ó bash**: –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –ø–æ–¥ CI-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
5. **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã**: –ù–µ—Ç wildcards, —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–µ –ø—É—Ç–∏ –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
6. **–¢–æ–ª—å–∫–æ user units**: System units –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω—ã
7. **Sudo -u –≤–º–µ—Å—Ç–æ runuser**: –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ —á–µ—Ä–µ–∑ sudoers
8. **Linuxadm-enable-linger**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è mon_sys

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 2.1. –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (KAE-based)

```
NAMESPACE_CI = "kvSec_CI84324523"
       ‚Üì
KAE = "CI84324523"  (–∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CI-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: CI84324523-lnx-mon_ci          ‚îÇ
‚îÇ  - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ü–£–ó/–¢–£–ó                         ‚îÇ
‚îÇ  - –ü–æ–¥ –Ω–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç Jenkins                      ‚îÇ
‚îÇ  - –ò–º–µ–µ—Ç sudo –ø—Ä–∞–≤–∞ –¢–û–õ–¨–ö–û –Ω–∞ systemctl --user   ‚îÇ
‚îÇ  - –°–∫—Ä–∏–ø—Ç —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è: ~/monitoring-deployment ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì (—É–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ sudo -u)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Sys-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: CI84324523-lnx-mon_sys        ‚îÇ
‚îÇ  - Nologin —Å–µ—Ä–≤–∏—Å–Ω–∞—è –£–ó                          ‚îÇ
‚îÇ  - –ü–æ–¥ –Ω–∏–º —Ä–∞–±–æ—Ç–∞—é—Ç —Å–µ—Ä–≤–∏—Å—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞          ‚îÇ
‚îÇ  - User units –≤ ~/.config/systemd/user/          ‚îÇ
‚îÇ  - Linger –≤–∫–ª—é—á–µ–Ω (—Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤—Å–µ–≥–¥–∞)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.2. –ü—É—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è (–ë–ï–ó sudo –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è)

```bash
/home/CI84324523-lnx-mon_ci/monitoring-deployment/
‚îú‚îÄ‚îÄ install-monitoring-stack.sh       # –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç
‚îú‚îÄ‚îÄ wrappers/                          # Security wrappers
‚îÇ   ‚îú‚îÄ‚îÄ secrets-manager-wrapper.sh     # –ù–û–í–û–ï: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ grafana-api-wrapper.sh         # –í—Å–µ curl —á–µ—Ä–µ–∑ –æ–±–µ—Ä—Ç–∫—É
‚îÇ   ‚îú‚îÄ‚îÄ rlm-api-wrapper.sh            # RLM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ firewall-manager.sh           # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ firewall
‚îÇ   ‚îî‚îÄ‚îÄ config-writer.sh              # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–ø–∏—Å—å –∫–æ–Ω—Ñ–∏–≥–æ–≤
‚îî‚îÄ‚îÄ temp_data_cred.json               # Credentials –∏–∑ Vault
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- ‚úÖ –ë–ï–ó sudo –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ (—Å–≤–æ–π –¥–æ–º–∞—à–Ω–∏–π –∫–∞—Ç–∞–ª–æ–≥)
- ‚úÖ –ë–ï–ó sudo –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
- ‚úÖ Sudo —Ç—Ä–µ–±—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –¥–ª—è systemctl --user (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏ sys-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

---

## 3. Secrets Management (–¢–∞–±–ª–∏—Ü–∞ 2 - –°–µ–∫—Ä–µ—Ç—ã)

### 3.1. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –ò–ë

> **–ò–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —Å –ò–ë:**  
> *"–ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, —Ç–æ —ç—Ç–æ —Ç–æ–∂–µ —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∏ –≤—Å–µ —Ä–∞–≤–Ω–æ, –∫–∞–∫ –º–∏–Ω–∏–º—É–º, –¥–æ–ª–∂–Ω–æ –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å—Å—è –≤ —Å–∫—Ä–∏–ø—Ç –æ–±–µ—Ä—Ç–∫—É —Å –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—á–∏—Å—Ç–∫–æ–π —ç—Ç–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π"*

### 3.2. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### ‚ùå –ë—ã–ª–æ (v3.x)
```bash
# –ü—Ä—è–º–æ–π jq, —Å–µ–∫—Ä–µ—Ç—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ë–ï–ó –æ—á–∏—Å—Ç–∫–∏
grafana_password=$(jq -r '.grafana_web.pass' "$file")
curl -u "user:$grafana_password" ...  # –ü–†–Ø–ú–û–ô curl —Å –ø–∞—Ä–æ–ª–µ–º!
# –ù–ï–¢ unset grafana_password
```

#### ‚úÖ –°—Ç–∞–ª–æ (v4.0)
```bash
# –ß–µ—Ä–µ–∑ secrets-manager-wrapper.sh
grafana_password=$("$WRAPPERS_DIR/secrets-manager-wrapper_launcher.sh" \
    extract_secret "$file" "grafana_web.pass")

# –ö–†–ò–¢–ò–ß–ù–û: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
trap 'unset grafana_password' RETURN

# –ù–ï–¢ –ø—Ä—è–º–æ–≥–æ curl - –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ –æ–±–µ—Ä—Ç–∫—É
resp=$("$WRAPPERS_DIR/grafana-api-wrapper_launcher.sh" \
    sa_create "$url" "$user" "$grafana_password")
```

### 3.3. Whitelist —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤

```bash
# –í secrets-manager-wrapper.sh
allowed_fields=(
    "grafana_web.user"
    "grafana_web.pass"
    "netapp_ssh.user"
    "netapp_ssh.pass"
    "vault-agent.role_id"
    "vault-agent.secret_id"
)
```

**–ó–∞—â–∏—Ç–∞**:
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–≤–ª–µ—á—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –ø–æ–ª—è
- ‚úÖ Whitelist JSON —Ñ–∞–π–ª–æ–≤ (`/opt/vault/conf/data_sec.json`, etc.)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ `unset` –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## 4. Curl Operations (–¢–∞–±–ª–∏—Ü–∞ 3 - –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã)

### 4.1. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –ò–ë

> **–ò–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π:**  
> *"curl - –∑–∞–ø—Ä–µ—â–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–∫–ª—é—á–µ–Ω–∏—è: —è–≤–Ω–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ª–µ–≥–∏—Ç–∏–º–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º (Nexus) —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç-–æ–±–µ—Ä—Ç–∫—É —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π."*

### 4.2. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### ‚ùå –ë—ã–ª–æ (v3.x)
```bash
# –ü–†–Ø–ú–û–ô eval curl —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
local resp=$(eval "curl -k -u \"${user}:${password}\" \"$url/api/health\"" 2>&1)
```

#### ‚úÖ –°—Ç–∞–ª–æ (v4.0)
```bash
# –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ grafana-api-wrapper_launcher.sh
local http_code=$("$WRAPPERS_DIR/grafana-api-wrapper_launcher.sh" \
    health_check "$grafana_url")
```

### 4.3. Whitelist –¥–ª—è Grafana API Wrapper

```bash
# –í grafana-api-wrapper.sh
validate_grafana_url() {
  local url="$1"
  # –°–¢–†–û–ì–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è: –¢–û–õ–¨–ö–û https + –ø–æ—Ä—Ç 3000
  [[ "$url" =~ ^https://[a-zA-Z0-9._-]+:3000(/.*)?$ ]] || fail "Invalid URL"
}
```

**–ó–∞—â–∏—Ç–∞**:
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å curl –Ω–∞–ø—Ä—è–º—É—é
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è URL –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
- ‚úÖ Whitelist —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö endpoints
- ‚úÖ SHA256 integrity check –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º wrapper

---

## 5. Sudoers Rules (–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏)

### 5.1. –ë—ã–ª–æ (v3.x) - –®–ò–†–û–ö–ò–ï –ü–†–ê–í–ê

```bash
# ‚ùå –û–ü–ê–°–ù–û: –ú–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å –õ–Æ–ë–û–ô —Å–∫—Ä–∏–ø—Ç —á–µ—Ä–µ–∑ bash
jenkins ALL=(ALL:ALL) NOEXEC: NOPASSWD: /bin/bash /usr/local/bin/install-monitoring-stack.sh

# ‚ùå –û–ü–ê–°–ù–û: Wildcards –ø–æ–∑–≤–æ–ª—è—é—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ª—é–±–æ–π .sh —Ñ–∞–π–ª
jenkins ALL=(ALL:ALL) NOEXEC: NOPASSWD: /usr/local/bin/wrappers/*.sh
```

### 5.2. –°—Ç–∞–ª–æ (v4.0) - –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ï –ü–†–ê–í–ê

```bash
# ‚úÖ –ö–û–ù–ö–†–ï–¢–ù–´–ï –∫–æ–º–∞–Ω–¥—ã systemctl --user –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è user-—é–Ω–∏—Ç–∞–º–∏
CI84324523-lnx-mon_ci ALL=(CI84324523-lnx-mon_sys) NOEXEC: NOPASSWD: \
  /usr/bin/systemctl --user daemon-reload, \
  /usr/bin/systemctl --user reset-failed monitoring-prometheus.service, \
  /usr/bin/systemctl --user reset-failed monitoring-grafana.service, \
  /usr/bin/systemctl --user reset-failed monitoring-harvest.service, \
  /usr/bin/systemctl --user enable monitoring-prometheus.service, \
  /usr/bin/systemctl --user enable monitoring-grafana.service, \
  /usr/bin/systemctl --user enable monitoring-harvest.service, \
  /usr/bin/systemctl --user restart monitoring-prometheus.service, \
  /usr/bin/systemctl --user restart monitoring-grafana.service, \
  /usr/bin/systemctl --user restart monitoring-harvest.service, \
  /usr/bin/systemctl --user stop monitoring-prometheus.service, \
  /usr/bin/systemctl --user stop monitoring-grafana.service, \
  /usr/bin/systemctl --user stop monitoring-harvest.service, \
  /usr/bin/systemctl --user status monitoring-prometheus.service, \
  /usr/bin/systemctl --user status monitoring-grafana.service, \
  /usr/bin/systemctl --user status monitoring-harvest.service, \
  /usr/bin/systemctl --user is-active monitoring-prometheus.service, \
  /usr/bin/systemctl --user is-active monitoring-grafana.service, \
  /usr/bin/systemctl --user is-active monitoring-harvest.service
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è**:
- ‚úÖ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π CI-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π sys-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- ‚úÖ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (`monitoring-*.service`)
- ‚úÖ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (restart, stop, status, etc.)
- ‚úÖ NOEXEC –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (–∑–∞—â–∏—Ç–∞ –æ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ systemctl)
- ‚úÖ –ù–ï–¢ wildcards (`*`)
- ‚úÖ –ù–ï–¢ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –ù–ï–¢ ALL=(ALL:ALL)

---

## 6. User Units vs System Units

### 6.1. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –ò–ë

> **–ò–∑ –º–µ—Ç–æ–¥–∏—á–∫–∏ SberInfra:**  
> *"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ user units –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –ê–° –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ. System units —Ç—Ä–µ–±—É—é—Ç root –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π."*

### 6.2. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### ‚ùå –ë—ã–ª–æ (v3.x)
```bash
# System units (/etc/systemd/system/) —Ç—Ä–µ–±—É—é—Ç root
systemctl daemon-reload              # –¢—Ä–µ–±—É–µ—Ç root
systemctl enable grafana-server      # –¢—Ä–µ–±—É–µ—Ç root
systemctl restart grafana-server     # –¢—Ä–µ–±—É–µ—Ç root

# Fallback: –µ—Å–ª–∏ user units –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ–º system
if ! systemctl --user ...; then
    sudo systemctl ...  # ‚ùå –®–∏—Ä–æ–∫–∏–µ sudo –ø—Ä–∞–≤–∞
fi
```

#### ‚úÖ –°—Ç–∞–ª–æ (v4.0)
```bash
# –¢–û–õ–¨–ö–û User units (~/.config/systemd/user/)
sudo -u CI84324523-lnx-mon_sys \
  env XDG_RUNTIME_DIR="/run/user/<UID>" \
  systemctl --user daemon-reload

sudo -u CI84324523-lnx-mon_sys \
  env XDG_RUNTIME_DIR="/run/user/<UID>" \
  systemctl --user enable monitoring-grafana.service

# –ù–ï–¢ fallback –Ω–∞ system units - –¢–û–õ–¨–ö–û user units!
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- ‚úÖ –ë–ï–ó root –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏
- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ—Ç–æ–¥–∏—á–∫–µ SberInfra
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ sudo –ø—Ä–∞–≤–∞ (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è CI ‚Üí sys)

---

## 7. Linger (linuxadm-enable-linger)

### 7.1. –ü—Ä–æ–±–ª–µ–º–∞

**–ë–ï–ó linger**: User units –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏ logout –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### 7.2. –†–µ—à–µ–Ω–∏–µ

```bash
# –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è mon_sys –≤ as-admin
if command -v linuxadm-enable-linger >/dev/null 2>&1; then
    linuxadm-enable-linger "CI84324523-lnx-mon_sys" || {
        print_error "–û—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è linger"
        exit 1
    }
    print_success "‚úÖ Linger –≤–∫–ª—é—á–µ–Ω –¥–ª—è CI84324523-lnx-mon_sys"
else
    print_error "‚ùå linuxadm-enable-linger –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi
```

**–ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç**:
- ‚úÖ User units –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å–ª–µ logout
- ‚úÖ –ë–ï–ó sudo (–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —á–ª–µ–Ω–æ–≤ as-admin)
- ‚úÖ –°–µ—Ä–≤–∏—Å—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç 24/7

---

## 8. –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –ê—Å–ø–µ–∫—Ç | Legacy (v3.x) | Secure Edition (v4.0) |
|--------|---------------|----------------------|
| **–ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞** | `sudo /bin/bash script.sh` | `./script.sh` (–ø–æ–¥ CI-user) |
| **Sudoers –ø—Ä–∞–≤–∞** | 4 —à–∏—Ä–æ–∫–∏—Ö –ø—Ä–∞–≤–∏–ª–∞ + wildcards | –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ systemctl –¥–ª—è CI‚Üísys |
| **–°–µ–∫—Ä–µ—Ç—ã** | `jq` –Ω–∞–ø—Ä—è–º—É—é, –Ω–µ—Ç `unset` | `secrets-manager-wrapper` + `trap unset` |
| **Curl** | `eval curl` —Å –ø–∞—Ä–æ–ª–µ–º | –¢–û–õ–¨–ö–û `grafana-api-wrapper` |
| **Service units** | System + fallback | –¢–û–õ–¨–ö–û user units |
| **Linger** | ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | ‚úÖ `linuxadm-enable-linger` |
| **–ü—É—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è** | `/tmp/` –∏–ª–∏ `/usr/local/bin/` | `~/monitoring-deployment/` |
| **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Jenkins** | jenkins@server | CI-user@server |

---

## 9. –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –∞—É–¥–∏—Ç–∞ –ò–ë

### ‚úÖ Secrets Management
- [x] –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —á–µ—Ä–µ–∑ `secrets-manager-wrapper.sh`
- [x] Whitelist —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π `unset` –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- [x] –ù–ï–¢ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –ª–æ–≥–∞—Ö

### ‚úÖ Curl Operations
- [x] –ù–ï–¢ –ø—Ä—è–º—ã—Ö curl –≤—ã–∑–æ–≤–æ–≤
- [x] –í—Å–µ —á–µ—Ä–µ–∑ `grafana-api-wrapper_launcher.sh`
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è URL –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
- [x] SHA256 integrity check –¥–ª—è wrappers

### ‚úÖ Sudoers
- [x] –ù–ï–¢ —à–∏—Ä–æ–∫–∏—Ö –ø—Ä–∞–≤ (ALL)
- [x] –ù–ï–¢ wildcards (*)
- [x] –ù–ï–¢ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [x] –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [x] NOEXEC –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω

### ‚úÖ User Units
- [x] –¢–û–õ–¨–ö–û user units (–ù–ï–¢ system units)
- [x] Linger –≤–∫–ª—é—á–µ–Ω —á–µ—Ä–µ–∑ `linuxadm-enable-linger`
- [x] –°–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ–¥ nologin –£–ó

### ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- [x] –ó–∞–ø—É—Å–∫ –ø–æ–¥ CI-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (–ë–ï–ó root)
- [x] –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ –¥–æ–º–∞—à–Ω–∏–π –∫–∞—Ç–∞–ª–æ–≥
- [x] –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ (Principle of Least Privilege)

---

## 10. –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

**–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:**
- üîí –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: [—Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª/email]
- üìã –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞: [—Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª/email]
- üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: [README.md](README.md), [README-MIGRATION.md](README-MIGRATION.md)

**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: **4.0.0 - Secure Edition**
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π: [CHANGELOG.md](CHANGELOG.md)

---

## 11. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç **Monitoring Stack Automation v4.0 - Secure Edition** –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±–∞–Ω–∫–∞. –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–º–µ—á–∞–Ω–∏—è —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã, –≤–Ω–µ–¥—Ä–µ–Ω—ã –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:

- ‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏** - —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ sudo –ø—Ä–∞–≤–∞
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏** - —á–µ—Ä–µ–∑ –æ–±–µ—Ä—Ç–∫–∏ —Å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–æ–π
- ‚úÖ **–ó–∞–ø—Ä–µ—Ç –ø—Ä—è–º—ã—Ö curl** - —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ validated wrappers
- ‚úÖ **User units only** - –±–µ–∑ root –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
- ‚úÖ **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ sudoers rules** - –±–µ–∑ wildcards –∏ —à–∏—Ä–æ–∫–∏—Ö –ø—Ä–∞–≤
- ‚úÖ **Linger enabled** - —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç 24/7

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –º–∞—Å—Å–æ–≤–æ–º—É —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –Ω–∞ **1000+ —Å–µ—Ä–≤–µ—Ä–æ–≤** –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–π —Å –ò–ë.

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-01-30  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
**–ê–≤—Ç–æ—Ä—ã:** Monitoring Team + –ò–ë –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
