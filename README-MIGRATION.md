# README-MIGRATION.md
## –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏: v3.x ‚Üí v4.0 Secure Edition

**–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è**: DevOps, SRE, –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ê–°  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏**: –°—Ä–µ–¥–Ω—è—è  
**–í—Ä–µ–º—è –Ω–∞ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä**: 30-60 –º–∏–Ω—É—Ç (–≤–∫–ª—é—á–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ò–ë)  
**–í—Ä–µ–º—è –Ω–∞ 1000 —Å–µ—Ä–≤–µ—Ä–æ–≤**: 2-4 –Ω–µ–¥–µ–ª–∏ (–≤–∫–ª—é—á–∞—è –ø–∏–ª–æ—Ç –∏ –º–∞—Å—Å–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)

---

## –†–µ–∑—é–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### üî¥ BREAKING CHANGES
–í–µ—Ä—Å–∏—è **4.0.0 - Secure Edition** —Å–æ–¥–µ—Ä–∂–∏—Ç **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ breaking changes**. –ü—Ä—è–º–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Å v3.x –ë–ï–ó –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –æ—à–∏–±–∫–∞–º.

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
1. **–ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: CI-user (mon_ci) + sys-user (mon_sys)
2. **–ù–æ–≤—ã–π –ø—É—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è**: `~/monitoring-deployment/` –≤–º–µ—Å—Ç–æ `/usr/local/bin/`
3. **–ù–æ–≤—ã–µ sudoers –ø—Ä–∞–≤–∏–ª–∞**: –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ systemctl –∫–æ–º–∞–Ω–¥—ã –≤–º–µ—Å—Ç–æ —à–∏—Ä–æ–∫–∏—Ö –ø—Ä–∞–≤
4. **–¢–æ–ª—å–∫–æ user units**: System units –±–æ–ª—å—à–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è
5. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π linger**: –î–ª—è —Ä–∞–±–æ—Ç—ã user units 24/7

---

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### 1. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ

- [x] **IDM –¥–æ—Å—Ç—É–ø**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è CI/–¢–£–ó –∏ nologin –£–ó
- [x] **–ó–∞—è–≤–∫–∞ –≤ –ò–ë**: –ü—Ä–∞–≤–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ sudo rules —á–µ—Ä–µ–∑ IDM
- [x] **Jenkins**: –î–æ—Å—Ç—É–ø –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º credentials –∏ pipelines
- [x] **RLM API**: –î–æ—Å—Ç—É–ø –∫ API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø (as-admin)
- [x] **Linuxadm**: –ù–∞–ª–∏—á–∏–µ `linuxadm-enable-linger` –Ω–∞ —Ü–µ–ª–µ–≤—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö

### 2. –ó–Ω–∞–Ω–∏—è

- [ ] –ü–æ–Ω–∏–º–∞–Ω–∏–µ KAE –º–æ–¥–µ–ª–∏ (NAMESPACE_CI ‚Üí KAE ‚Üí usernames)
- [ ] –û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã —Å user units (systemctl --user)
- [ ] –ë–∞–∑–æ–≤—ã–µ –∑–Ω–∞–Ω–∏—è sudoers —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
- [ ] –ü–æ–Ω–∏–º–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞ (—Å–º. [SECURITY-COMPLIANCE.md](SECURITY-COMPLIANCE.md))

---

## –ü—Ä–æ—Ü–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (1-2 –¥–Ω—è)

#### 1.1. –ò–∑—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

```bash
# –°–∫–∞—á–∞–π—Ç–µ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
cd /path/to/monitoring-stack-automation-secure

# –ò–∑—É—á–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
cat SECURITY-COMPLIANCE.md    # –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
cat CHANGELOG.md               # –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
cat sudoers.example            # –ù–æ–≤—ã–µ sudoers –ø—Ä–∞–≤–∏–ª–∞
cat Jenkinsfile                # –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ pipeline
```

#### 1.2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ KAE

```bash
# –í–∞—à NAMESPACE_CI (–∏–∑ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏)
NAMESPACE_CI="kvSec_CI84324523"

# –ò–∑–≤–ª–µ–∫–∞–µ–º KAE
KAE=$(echo "$NAMESPACE_CI" | cut -d'_' -f2)
echo "KAE=$KAE"  # Output: CI84324523

# –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CI_USER="${KAE}-lnx-mon_ci"    # CI84324523-lnx-mon_ci
SYS_USER="${KAE}-lnx-mon_sys"   # CI84324523-lnx-mon_sys
```

#### 1.3. –°–æ–∑–¥–∞–Ω–∏–µ —É—á—ë—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π —á–µ—Ä–µ–∑ IDM

**–î–ª—è –ö–ê–ñ–î–û–ì–û KAE** (–µ—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Å–∫–æ–ª—å–∫–æ):

```
–ó–∞—è–≤–∫–∞ 1: –°–æ–∑–¥–∞–Ω–∏–µ CI-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –¢–∏–ø –£–ó: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ü–£–ó/–¢–£–ó
- Username: CI84324523-lnx-mon_ci
- –û–ø–∏—Å–∞–Ω–∏–µ: "CI-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è monitoring stack"
- –ì—Ä—É–ø–ø—ã: [–æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º, –¥–æ–±–∞–≤–∏–º —á–µ—Ä–µ–∑ RLM]

–ó–∞—è–≤–∫–∞ 2: –°–æ–∑–¥–∞–Ω–∏–µ sys-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –¢–∏–ø –£–ó: Nologin (—Å–µ—Ä–≤–∏—Å–Ω–∞—è)
- Username: CI84324523-lnx-mon_sys
- –û–ø–∏—Å–∞–Ω–∏–µ: "Sys-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞"
- Shell: /sbin/nologin
- –ì—Ä—É–ø–ø—ã: [–æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º, –¥–æ–±–∞–≤–∏–º —á–µ—Ä–µ–∑ RLM]
```

#### 1.4. –°–æ–∑–¥–∞–Ω–∏–µ sudoers –ø—Ä–∞–≤–∏–ª —á–µ—Ä–µ–∑ IDM

**–®–∞–±–ª–æ–Ω –∑–∞—è–≤–∫–∏ –≤ –ò–ë**:

```
–¢–µ–º–∞: –°–æ–∑–¥–∞–Ω–∏–µ sudoers –ø—Ä–∞–≤–∏–ª –¥–ª—è Monitoring Stack v4.0 (Secure Edition)

–ö–ê–ï: CI84324523
–°–µ—Ä–≤–µ—Ä–∞: [—Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏–ª–∏ –≥—Ä—É–ø–ø–∞]
–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ò–ë –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º

Sudoers –ø—Ä–∞–≤–∏–ª–∞ (—Å–º. –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ sudoers.template):

CI84324523-lnx-mon_ci ALL=(CI84324523-lnx-mon_sys) NOEXEC: NOPASSWD: \
  /usr/bin/systemctl --user daemon-reload, \
  /usr/bin/systemctl --user reset-failed monitoring-prometheus.service, \
  /usr/bin/systemctl --user reset-failed monitoring-grafana.service, \
  /usr/bin/systemctl --user reset-failed monitoring-harvest.service, \
  /usr/bin/systemctl --user enable monitoring-prometheus.service, \
  /usr/bin/systemctl --user enable monitoring-grafana.service, \
  /usr/bin/systemctl --user enable monitoring-harvest.service, \
  /usr/bin/systemctl --user restart monitoring-prometheus.service, \
  /usr/bin/systemctl --user restart monitoring-grafana.service, \
  /usr/bin/systemctl --user restart monitoring-harvest.service, \
  /usr/bin/systemctl --user stop monitoring-prometheus.service, \
  /usr/bin/systemctl --user stop monitoring-grafana.service, \
  /usr/bin/systemctl --user stop monitoring-harvest.service, \
  /usr/bin/systemctl --user status monitoring-prometheus.service, \
  /usr/bin/systemctl --user status monitoring-grafana.service, \
  /usr/bin/systemctl --user status monitoring-harvest.service, \
  /usr/bin/systemctl --user is-active monitoring-prometheus.service, \
  /usr/bin/systemctl --user is-active monitoring-grafana.service, \
  /usr/bin/systemctl --user is-active monitoring-harvest.service

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
1. sudoers.template - –¥–µ—Ç–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
2. SECURITY-COMPLIANCE.md - –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
```

---

### –≠—Ç–∞–ø 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Jenkins (1 –¥–µ–Ω—å)

#### 2.1. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö SSH Credentials

```
Jenkins ‚Üí Manage Jenkins ‚Üí Credentials ‚Üí Add Credentials

ID: monitoring-stack-ci-user-ssh
Type: SSH Username with private key
Username: CI84324523-lnx-mon_ci
Private Key: [SSH –∫–ª—é—á –¥–ª—è CI-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
Description: SSH –¥–ª—è CI-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Monitoring Stack v4.0)
```

#### 2.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Jenkinsfile

```groovy
// –§–∞–π–ª: Jenkinsfile (–∏–∑ monitoring-stack-automation-secure/)
// –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤—ã–π Jenkinsfile –∏–∑ –ø–∞–ø–∫–∏ -secure!

parameters {
    string(name: 'SERVER_ADDRESS', ...)
    string(name: 'SSH_CREDENTIALS_ID', defaultValue: 'monitoring-stack-ci-user-ssh', ...)  // –ù–û–í–û–ï
    string(name: 'NAMESPACE_CI', ...) // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è KAE
    ...
}

environment {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ KAE –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    KAE = "${params.NAMESPACE_CI}".split('_')[1]
    DEPLOY_USER = "${KAE}-lnx-mon_ci"
    MON_SYS_USER = "${KAE}-lnx-mon_sys"
    DEPLOY_PATH = "/home/${DEPLOY_USER}/monitoring-deployment"
}
```

#### 2.3. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ pipeline

```bash
# –°–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π pipeline –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
Jenkins ‚Üí New Item ‚Üí Pipeline
Name: monitoring-stack-v4-test
Pipeline script from SCM:
  Repository: [–≤–∞—à Git repo]
  Branch: master (–∏–ª–∏ –≤–µ—Ç–∫–∞ —Å v4.0)
  Script Path: monitoring-stack-automation-secure/Jenkinsfile
```

---

### –≠—Ç–∞–ø 3: –ü–∏–ª–æ—Ç–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (3-5 –¥–Ω–µ–π)

#### 3.1. –í—ã–±–æ—Ä –ø–∏–ª–æ—Ç–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∞** (5-10 —Å–µ—Ä–≤–µ—Ä–æ–≤):
- ‚úÖ DEV/TEST –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–Ω–µ PROD!)
- ‚úÖ –†–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –û–° (SBEL 8, SBEL 9, RHEL 8)
- ‚úÖ –†–∞–∑–Ω—ã–µ KAE (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
- ‚úÖ –î–æ—Å—Ç—É–ø –∫ linuxadm-enable-linger
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–∞—Ç–∞

#### 3.2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∏–ª–æ—Ç–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤

**–î–ª—è –ö–ê–ñ–î–û–ì–û –ø–∏–ª–æ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞:**

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —É—á—ë—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
ssh admin@pilot-server-01
id CI84324523-lnx-mon_ci   # –î–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
id CI84324523-lnx-mon_sys  # –î–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å

# 2. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –°–æ–∑–¥–∞–Ω–∏–µ home –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
# –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω—ã —á–µ—Ä–µ–∑ IDM, –∏—Ö home –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –º–æ–≥—É—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
sudo mkhomedir_helper CI84324523-lnx-mon_ci
sudo mkhomedir_helper CI84324523-lnx-mon_sys

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–∞–≤
ls -ld /home/CI84324523-lnx-mon_ci
ls -ld /home/CI84324523-lnx-mon_sys
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å: drwx------ –≤–ª–∞–¥–µ–ª–µ—Ü=CI84324523-lnx-mon_ci (–∏–ª–∏ mon_sys)

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ sudoers –ø—Ä–∞–≤–∏–ª
sudo -l -U CI84324523-lnx-mon_ci
# –î–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è systemctl --user

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ linuxadm
which linuxadm-enable-linger  # –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–µ–Ω

# 5. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
# –ï—Å–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —É–∂–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ v3.x, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã:
sudo systemctl stop prometheus grafana-server harvest
sudo systemctl disable prometheus grafana-server harvest
```

#### 3.3. –ó–∞–ø—É—Å–∫ –ø–∏–ª–æ—Ç–Ω–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

```bash
# Jenkins ‚Üí monitoring-stack-v4-test ‚Üí Build with Parameters
SERVER_ADDRESS: pilot-server-01.domain.ru
SSH_CREDENTIALS_ID: monitoring-stack-ci-user-ssh
NAMESPACE_CI: kvSec_CI84324523
SKIP_VAULT_INSTALL: true   # –ï—Å–ª–∏ vault-agent —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
SKIP_RPM_INSTALL: false    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º RPM –ø–∞–∫–µ—Ç—ã
SKIP_CI_CHECKS: true       # –£—Å–∫–æ—Ä—è–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
```

#### 3.4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```bash
ssh CI84324523-lnx-mon_ci@pilot-server-01

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤
ls -la ~/monitoring-deployment/
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å: install-monitoring-stack.sh, wrappers/, temp_data_cred.json

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ linger
loginctl show-user CI84324523-lnx-mon_sys | grep Linger
# Output: Linger=yes

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ user units
sudo -u CI84324523-lnx-mon_sys \
  env XDG_RUNTIME_DIR="/run/user/$(id -u CI84324523-lnx-mon_sys)" \
  systemctl --user list-units 'monitoring-*'
  
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å active:
# monitoring-prometheus.service
# monitoring-grafana.service
# monitoring-harvest.service

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
ss -tln | grep -E ':(3000|9090|12990|12991)'
# –í—Å–µ 4 –ø–æ—Ä—Ç–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
curl -k https://localhost:3000/api/health
# Output: {"database":"ok",...}

curl -k https://localhost:9090/-/healthy
# Output: Prometheus is Healthy
```

---

### –≠—Ç–∞–ø 4: –ê–Ω–∞–ª–∏–∑ –∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∞ (2-3 –¥–Ω—è)

#### 4.1. –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –ø–∏–ª–æ—Ç–∞

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å**:
- [ ] –í—Ä–µ–º—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ~10-15 –º–∏–Ω—É—Ç)
- [ ] –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (100%)
- [ ] –ù–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö Jenkins
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
- [ ] –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã linger (—Å–µ—Ä–≤–∏—Å—ã –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è)

#### 4.2. –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

| –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|---------|
| User unit –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è | Linger –Ω–µ –≤–∫–ª—é—á–µ–Ω | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `loginctl show-user`, –≤–∫–ª—é—á–∏—Ç—å linger –≤—Ä—É—á–Ω—É—é |
| Permission denied –¥–ª—è systemctl --user | Sudoers –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å sudoers —á–µ—Ä–µ–∑ `sudo -l -U` |
| –§–∞–π–ª—ã –Ω–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ ~/monitoring-deployment | –ù–µ–≤–µ—Ä–Ω—ã–π SSH user | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SSH_CREDENTIALS_ID –≤ Jenkins |
| linuxadm-enable-linger not found | –ü–∞–∫–µ—Ç –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç linuxadm –∏–ª–∏ –∞–Ω–∞–ª–æ–≥ |

#### 4.3. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

–°–æ–∑–¥–∞–π—Ç–µ –æ—Ç—á—ë—Ç –æ –ø–∏–ª–æ—Ç–µ:

```markdown
## –û—Ç—á–µ—Ç –æ –ø–∏–ª–æ—Ç–Ω–æ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏ v4.0

**–î–∞—Ç–∞**: 2026-02-01  
**–°–µ—Ä–≤–µ—Ä–æ–≤**: 10  
**–£—Å–ø–µ—à–Ω–æ**: 9 (90%)  
**–ü—Ä–æ–±–ª–µ–º—ã**: 1 (linuxadm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ SBEL8)

### –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
1. **–°–µ—Ä–≤–µ—Ä pilot-04**: linuxadm-enable-linger –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
   - –†–µ—à–µ–Ω–∏–µ: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–∞–∫–µ—Ç —á–µ—Ä–µ–∑ yum
   - –í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: 10 –º–∏–Ω—É—Ç

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ª–∏—á–∏—è linuxadm –≤ pre-flight checks
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É linuxadm –≤ README

### –†–µ—à–µ–Ω–∏–µ: –ì–æ—Ç–æ–≤ –∫ –º–∞—Å—Å–æ–≤–æ–º—É —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
```

---

### –≠—Ç–∞–ø 5: –ú–∞—Å—Å–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (2-4 –Ω–µ–¥–µ–ª–∏ –¥–ª—è 1000 —Å–µ—Ä–≤–µ—Ä–æ–≤)

#### 5.1. –ü–ª–∞–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è**: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏ –ø–æ 50-100 —Å–µ—Ä–≤–µ—Ä–æ–≤

```
–ù–µ–¥–µ–ª—è 1: –ì—Ä—É–ø–ø–∞ 1 (100 —Å–µ—Ä–≤–µ—Ä–æ–≤) ‚Üí –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 3 –¥–Ω—è ‚Üí –ê–Ω–∞–ª–∏–∑
–ù–µ–¥–µ–ª—è 2: –ì—Ä—É–ø–ø–∞ 2 (200 —Å–µ—Ä–≤–µ—Ä–æ–≤) ‚Üí –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 2 –¥–Ω—è ‚Üí –ê–Ω–∞–ª–∏–∑
–ù–µ–¥–µ–ª—è 3: –ì—Ä—É–ø–ø–∞ 3 (300 —Å–µ—Ä–≤–µ—Ä–æ–≤) ‚Üí –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 2 –¥–Ω—è ‚Üí –ê–Ω–∞–ª–∏–∑
–ù–µ–¥–µ–ª—è 4: –ì—Ä—É–ø–ø–∞ 4 (400 —Å–µ—Ä–≤–µ—Ä–æ–≤) ‚Üí –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 1 –¥–µ–Ω—å ‚Üí –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
```

#### 5.2. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Jenkins

```groovy
// –ú–∞—Å—Å–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π pipeline
pipeline {
    parameters {
        text(name: 'SERVER_LIST', description: '–°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)')
    }
    stages {
        stage('Deploy to multiple servers') {
            steps {
                script {
                    def servers = params.SERVER_LIST.split('\n')
                    servers.each { server ->
                        build job: 'monitoring-stack-v4-prod',
                              parameters: [
                                  string(name: 'SERVER_ADDRESS', value: server.trim()),
                                  string(name: 'SSH_CREDENTIALS_ID', value: 'monitoring-stack-ci-user-ssh'),
                                  string(name: 'NAMESPACE_CI', value: 'kvSec_CI84324523')
                              ]
                    }
                }
            }
        }
    }
}
```

#### 5.3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

**Dashboard –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è**:
- üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–π (–ø–æ –¥–Ω—è–º)
- üìä –í—Ä–µ–º—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è (—Å—Ä–µ–¥–Ω–µ–µ/–º–µ–¥–∏–∞–Ω–∞/P95)
- üìä –¢–æ–ø-5 –æ—à–∏–±–æ–∫
- üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤ –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

---

### –≠—Ç–∞–ø 6: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ v4.0 –≤ production (1-2 –¥–Ω—è)

#### 6.1. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ pipelines

```bash
# –°—Ç–∞—Ä—ã–π pipeline
monitoring-stack-v3-prod ‚Üí monitoring-stack-v3-legacy (–∞—Ä—Ö–∏–≤)

# –ù–æ–≤—ã–π pipeline
monitoring-stack-v4-prod ‚Üí monitoring-stack-prod (production)
```

#### 6.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

- [ ] –û–±–Ω–æ–≤–∏—Ç—å Wiki/Confluence —Å –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
- [ ] –û–±–Ω–æ–≤–∏—Ç—å runbooks –¥–ª—è troubleshooting
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- [ ] –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é v3.x

#### 6.3. –û–±—É—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã

**–¢–µ–º—ã –¥–ª—è –æ–±—É—á–µ–Ω–∏—è**:
1. –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (CI + sys)
2. User units –≤–º–µ—Å—Ç–æ system units
3. –ù–æ–≤—ã–µ sudoers –ø—Ä–∞–≤–∏–ª–∞
4. Troubleshooting linger
5. Secrets management —á–µ—Ä–µ–∑ wrappers

---

## –û—Ç–∫–∞—Ç –Ω–∞ v3.x (Emergency Rollback)

### –ö–æ–≥–¥–∞ –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å?

- ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ v4.0 (—Å–µ—Ä–≤–∏—Å—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –Ω–∞ >50% —Å–µ—Ä–≤–µ—Ä–æ–≤)
- ‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
- ‚ùå –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å –¥—Ä—É–≥–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏

### –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –æ—Ç–∫–∞—Ç–∞

```bash
# 1. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å Jenkins –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ v3.x Jenkinsfile
Jenkins ‚Üí monitoring-stack-prod ‚Üí Configure
Pipeline ‚Üí Script Path: Jenkinsfile (–≤–µ—Ç–∫–∞ v3.x)

# 2. –ù–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å v4.0 user units
ssh CI84324523-lnx-mon_ci@server
sudo -u CI84324523-lnx-mon_sys \
  env XDG_RUNTIME_DIR="/run/user/$(id -u CI84324523-lnx-mon_sys)" \
  systemctl --user stop monitoring-prometheus monitoring-grafana monitoring-harvest

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ system units
ssh admin@server
sudo systemctl start prometheus grafana-server harvest
sudo systemctl enable prometheus grafana-server harvest

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
curl -k https://localhost:3000/api/health
curl -k https://localhost:9090/-/healthy
```

**–í—Ä–µ–º—è –Ω–∞ –æ—Ç–∫–∞—Ç**: 30-60 –º–∏–Ω—É—Ç –Ω–∞ –≥—Ä—É–ø–ø—É —Å–µ—Ä–≤–µ—Ä–æ–≤

---

## FAQ

### Q1: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å v4.0 –∏ v3.x –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ?

**A:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –¥–∞, –Ω–æ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è. User units (v4.0) –∏ system units (v3.x) –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ä–∞–∑–Ω—ã–µ –ø–æ—Ä—Ç—ã –∏ –ø—É—Ç–∏, –Ω–æ —ç—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –ø—É—Ç–∞–Ω–∏—Ü—É. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è.

### Q2: –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –ò–ë –æ—Ç–∫–ª–æ–Ω–∏–ª–∞ sudoers –ø—Ä–∞–≤–∏–ª–∞?

**A:** –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É [SECURITY-COMPLIANCE.md](SECURITY-COMPLIANCE.md) - —Ç–∞–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞. –ï—Å–ª–∏ –ò–ë —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∫–æ–º–∞–Ω–¥–æ–π –ø—Ä–æ–µ–∫—Ç–∞.

### Q3: –ú–æ–∂–Ω–æ –ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ CI-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?

**A:** –ù–µ—Ç. CI-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (`${KAE}-lnx-mon_ci`) - –∫–ª—é—á–µ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã v4.0. –ë–µ–∑ –Ω–µ–≥–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ.

### Q4: –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ v4.0 –Ω–∞ RHEL 7?

**A:** –ß–∞—Å—Ç–∏—á–Ω–æ. User units –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Å systemd 219+, –Ω–æ `linuxadm-enable-linger` –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è SBEL 8+ –∏–ª–∏ RHEL 8+.

### Q5: –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–π–º—ë—Ç –º–∏–≥—Ä–∞—Ü–∏—è 1000 —Å–µ—Ä–≤–µ—Ä–æ–≤?

**A:** 2-4 –Ω–µ–¥–µ–ª–∏, –≤–∫–ª—é—á–∞—è:
- 1-2 –¥–Ω—è: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (IDM, –ò–ë, Jenkins)
- 3-5 –¥–Ω–µ–π: –ü–∏–ª–æ—Ç (10 —Å–µ—Ä–≤–µ—Ä–æ–≤)
- 2-4 –Ω–µ–¥–µ–ª–∏: –ú–∞—Å—Å–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

**–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏:**
- üìã –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞: [—Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª]
- üîí –í–æ–ø—Ä–æ—Å—ã –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –ò–ë –æ—Ç–¥–µ–ª
- üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: [README.md](README.md), [SECURITY-COMPLIANCE.md](SECURITY-COMPLIANCE.md)

**–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –¶–µ–ª–µ–≤–∞—è –≤–µ—Ä—Å–∏—è: **4.0.0 - Secure Edition**
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π: [CHANGELOG.md](CHANGELOG.md)

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-01-30  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
**–ê–≤—Ç–æ—Ä—ã:** Monitoring Team
