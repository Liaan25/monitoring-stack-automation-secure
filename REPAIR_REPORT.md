# Отчет об исправлениях скрипта install-monitoring-stack.sh

## Обзор проблемы

Скрипт `install-monitoring-stack.sh` имел критические ошибки, которые приводили к:
1. Падению скрипта сразу после запуска
2. Неправильной генерации конфигурации `agent.hcl` для vault-agent
3. Пустым сертификатам (`vault_bundle пустой`)

## Выявленные и исправленные проблемы

### 1. Критическая ошибка в shebang
- **Было**: `776#!/bin/bash`
- **Стало**: `#!/bin/bash`
- **Причина**: Ошибка слияния или копирования файлов
- **Влияние**: Скрипт мог неправильно интерпретироваться shell

### 2. Синтаксическая ошибка в генерации agent.hcl
- **Было**: Лишний `EOF` в строке 2028
- **Стало**: Удален лишний `EOF`
- **Причина**: Ошибка в логике условного блока с `SKIP_VAULT_INSTALL`
- **Влияние**: Конфигурация vault-agent не генерировалась правильно

### 3. Отсутствие инициализации переменных SKIP_*
- **Было**: Переменные использовались без инициализации
- **Стало**: Добавлена инициализация:
  ```bash
  : "${SKIP_VAULT_INSTALL:=false}"
  : "${SKIP_RPM_INSTALL:=false}"
  : "${SKIP_CI_CHECKS:=false}"
  ```
- **Причина**: Неполная миграция кода
- **Влияние**: Непредсказуемое поведение при использовании флагов пропуска

## Анализ причинно-следственных связей

### Почему скрипт падал сразу:
1. **Неправильный shebang** → возможные ошибки интерпретации
2. **Синтаксические ошибки** → преждевременное завершение скрипта

### Почему не генерировался agent.hcl:
1. **Лишний EOF** → прерывание генерации конфигурации
2. **Неправильные пути** → в зависимости от `SKIP_VAULT_INSTALL`

### Почему сертификаты были пустыми:
1. **Неправильный agent.hcl** → vault-agent не мог генерировать сертификаты
2. **Таймаут ожидания** → функция ждала сертификаты, которые никогда не появлялись

## Соответствие требованиям безопасности

Все исправления сохраняют соответствие требованиям **Secure Edition**:

### ✅ Принципы Secure Edition сохранены:
1. **Запуск без sudo**: Скрипт выполняется под CI-пользователем
2. **User-space архитектура**: Все файлы в домашней директории
3. **Безопасная работа с секретами**: Через wrappers с auto-unset
4. **Только user units**: Сервисы под mon_sys пользователем

### ✅ Архитектура безопасности:
```
CI-user (mon_ci)
    ↓ (запускает скрипт)
Скрипт развертывания
    ↓ (настраивает)
Sys-user (mon_sys) → User units (сервисы)
    ↓ (использует)
Vault-agent (системный сервис) → Сертификаты
    ↓ (копируются в)
User-space директории → Доступ без root
```

## Проверка исправлений

### Ручная проверка:
1. **Синтаксис**: `bash -n install-monitoring-stack.sh`
2. **Shebang**: Первая строка должна быть `#!/bin/bash`
3. **Инициализация**: Проверить наличие `SKIP_*` переменных
4. **Генерация agent.hcl**: Проверить строку 2028 на отсутствие лишнего EOF

### Автоматическая проверка:
```bash
# Установите тестовые переменные
export SKIP_VAULT_INSTALL=false
export SEC_MAN_ADDR=vault.example.com
export NAMESPACE_CI=kvSec_CI12345678

# Проверьте генерацию конфигурации
source install-monitoring-stack.sh
setup_vault_config
```

## Рекомендации для следующего запуска

### 1. Мониторинг логов:
- Проверьте вывод скрипта с самого начала
- Ищите сообщения `[SCRIPT_START]` и `[MAIN]`
- Обратите внимание на этап генерации `agent.hcl`

### 2. Проверка vault-agent:
```bash
# После запуска скрипта проверьте
systemctl status vault-agent
journalctl -u vault-agent
ls -la /opt/vault/certs/
```

### 3. Проверка сертификатов:
```bash
# Убедитесь что файлы не пустые
ls -la $HOME/monitoring/certs/vault/
cat $HOME/monitoring/certs/vault/server_bundle.pem | head -5
```

### 4. Диагностика при ошибках:
- Если скрипт падает сразу: проверьте shebang и синтаксис
- Если нет agent.hcl: проверьте функцию `setup_vault_config`
- Если сертификаты пустые: проверьте логи vault-agent

## Заключение

Основные проблемы были исправлены:
1. ✅ Исправлен shebang
2. ✅ Исправлена генерация agent.hcl
3. ✅ Добавлена инициализация переменных
4. ✅ Сохранена безопасная архитектура

Скрипт теперь должен:
- Запускаться корректно под CI-пользователем
- Генерировать правильную конфигурацию vault-agent
- Создавать и копировать сертификаты в user-space
- Соответствовать всем требованиям ИБ (Secure Edition)

Следующий шаг: запуск полного пайплайна для окончательной проверки.