# ÐšÐ°Ðº Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ðº vault-agent Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ñƒ (LEGACY)

**Ð”Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ:** 15.02.2026  
**Ð’ÐµÑ€ÑÐ¸Ñ:** 1.0  
**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** Ð£Ð¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ‹Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ (Ð±ÐµÐ· vault-agent) â€” Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ  

---

## ðŸ“‹ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ

1. [Ð’Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ](#Ð²Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ)
2. [Ð—Ð°Ñ‡ÐµÐ¼ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒÑÑ Ðº vault-agent?](#Ð·Ð°Ñ‡ÐµÐ¼-Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒÑÑ-Ðº-vault-agent)
3. [ÐŸÐ¾ÑˆÐ°Ð³Ð¾Ð²Ð°Ñ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ](#Ð¿Ð¾ÑˆÐ°Ð³Ð¾Ð²Ð°Ñ-Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ)
4. [ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸](#Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°-Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸)
5. [ÐžÑ‚ÐºÐ°Ñ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹](#Ð¾Ñ‚ÐºÐ°Ñ‚-Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹)

---

## Ð’Ð²ÐµÐ´ÐµÐ½Ð¸Ðµ

ÐÐ°Ñ‡Ð¸Ð½Ð°Ñ Ñ Ð²ÐµÑ€ÑÐ¸Ð¸ **4.1**, Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ **ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ‹Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ Ð±ÐµÐ· vault-agent**, Ð³Ð´Ðµ:
- âœ… Ð’ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ…Ñ€Ð°Ð½ÑÑ‚ÑÑ Ð² `$HOME/monitoring/` (user-space)
- âœ… Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÑŽÑ‚ÑÑ Ð¸Ð· Jenkins Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°ÑŽÑ‚ÑÑ self-signed
- âœ… ÐÐ• Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ sudo Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð²Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
- âœ… ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸ `/opt/vault/`

**LEGACY Ð¿Ð¾Ð´Ñ…Ð¾Ð´ (vault-agent)** Ð±Ñ‹Ð» Ð·Ð°ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½, Ð½Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸.

---

## Ð—Ð°Ñ‡ÐµÐ¼ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒÑÑ Ðº vault-agent?

### ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð° vault-agent:

- âœ… **ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²** (ÐºÐ°Ð¶Ð´Ñ‹Ðµ N Ñ‡Ð°ÑÐ¾Ð²)
- âœ… **ÐÐµÐ¿Ñ€ÐµÑ€Ñ‹Ð²Ð½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ secrets** Ð¸Ð· Vault
- âœ… **Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð¾Ðµ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ** ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· Vault
- âœ… **Ð Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ðµ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²** Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ

### ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ¸ vault-agent:

- âŒ **Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ sudo** Ð´Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ð² `/opt/vault/`
- âŒ **Ð¡Ð»Ð¾Ð¶Ð½ÐµÐµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°** Ð¸ troubleshooting
- âŒ **Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ** Ð¾Ñ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ð³Ð¾ ÑÐµÑ€Ð²Ð¸ÑÐ° `vault-agent`
- âŒ **Ð¢Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑÑ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸** (va-start, va-read)

---

## ÐŸÐ¾ÑˆÐ°Ð³Ð¾Ð²Ð°Ñ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ

### Ð¨Ð°Ð³ 1: Ð Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ `setup_vault_config()`

Ð’ Ñ„Ð°Ð¹Ð»Ðµ `install-monitoring-stack.sh`:

1. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÑÐµÐºÑ†Ð¸ÑŽ:
   ```bash
   # ============================================================
   # LEGACY APPROACH: vault-agent with system paths (/opt/vault/)
   # ============================================================
   ```

2. Ð Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ `setup_vault_config()` **(ÑÑ‚Ñ€Ð¾ÐºÐ¸ 1814-2618)**:
   - Ð£Ð´Ð°Ð»Ð¸Ñ‚Ðµ `#` Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
   - Ð˜Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ñ€Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (ÑÐ¼. Ð½Ð¸Ð¶Ðµ)

#### Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ñ€Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:

```bash
# Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ uncomment_function.py
cat > tools/uncomment_function.py << 'EOF'
#!/usr/bin/env python3
import sys

def uncomment_function(input_file, output_file, start_line, end_line):
    with open(input_file, 'r', encoding='utf-8') as f:
        lines = f.readlines()
    
    for i in range(start_line - 1, min(end_line, len(lines))):
        line = lines[i]
        if line.startswith('#'):
            lines[i] = line[1:]  # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑÐ¸Ð¼Ð²Ð¾Ð» #
    
    with open(output_file, 'w', encoding='utf-8') as f:
        f.writelines(lines)
    
    print(f"[OK] Uncommented lines {start_line}-{end_line}")

if __name__ == "__main__":
    uncomment_function(sys.argv[1], sys.argv[2], int(sys.argv[3]), int(sys.argv[4]))
EOF

# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ:
python tools/uncomment_function.py \
    install-monitoring-stack.sh \
    install-monitoring-stack.sh.new \
    1814 2618

# Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð»:
mv install-monitoring-stack.sh.new install-monitoring-stack.sh
```

---

### Ð¨Ð°Ð³ 2: ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð·Ð¾Ð² Ð² `main()`

Ð’ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ `main()` (Ñ„Ð°Ð¹Ð» `install-monitoring-stack.sh`):

1. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÑÐµÐºÑ†Ð¸ÑŽ:
   ```bash
   # ============================================================
   # LEGACY: setup_vault_config (Ð·Ð°ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½)
   # ============================================================
   ```

2. **Ð—Ð°ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ** Ð²Ñ‹Ð·Ð¾Ð² `get_certificates_from_jenkins`:
   ```bash
   # echo "[MAIN] Ð’Ñ‹Ð·Ð¾Ð² get_certificates_from_jenkins..." | tee /dev/stderr
   # get_certificates_from_jenkins
   # echo "[MAIN] âœ… get_certificates_from_jenkins Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾" | tee /dev/stderr
   ```

3. **Ð Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ** Ð²Ñ‹Ð·Ð¾Ð² `setup_vault_config`:
   ```bash
   echo "[MAIN] Ð’Ñ‹Ð·Ð¾Ð² setup_vault_config..." | tee /dev/stderr
   log_debug "Calling: setup_vault_config"
   
   setup_vault_config
   
   echo "[MAIN] âœ… setup_vault_config Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾" | tee /dev/stderr
   log_debug "Completed: setup_vault_config"
   write_diagnostic "setup_vault_config Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð°"
   ```

---

### Ð¨Ð°Ð³ 3: Ð Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ sudo-Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°

Ð’ Ñ„Ð°Ð¹Ð»Ðµ `sudoers.example`:

1. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÑÐµÐºÑ†Ð¸ÑŽ:
   ```bash
   # ============================================================
   # LEGACY: System-level Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ (Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ root)
   # ============================================================
   ```

2. Ð Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ **Ð²ÑÐµ ÑÑ‚Ñ€Ð¾ÐºÐ¸** (ÑƒÐ´Ð°Ð»Ð¸Ñ‚Ðµ `# ` Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ):
   ```bash
   ALL=(root) NOEXEC: NOPASSWD: /usr/bin/cp /tmp/role_id_*.txt /opt/vault/conf/role_id.txt
   ALL=(root) NOEXEC: NOPASSWD: /usr/bin/cp /tmp/secret_id_*.txt /opt/vault/conf/secret_id.txt
   # ... Ð¸ Ñ‚.Ð´.
   ```

---

### Ð¨Ð°Ð³ 4: Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ IDM Ð·Ð°ÑÐ²ÐºÑƒ

1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ **ÐÐ¡ Ð¡Ð£Ð£ÐŸÐ¢ (IDM)**: https://suupt.sberbank.ru/

2. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð·Ð°ÑÐ²ÐºÑƒ Ð½Ð° **Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð² sudo** Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ `${KAE}-lnx-mon_ci`

3. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ **Ñ€Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°** Ð¸Ð· `sudoers.example` (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 36-68)

4. Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð² Ð·Ð°ÑÐ²ÐºÐµ:
   - **Ð¡ÐµÑ€Ð²ÐµÑ€:** tvlds-mvp001939 (Ð²Ð°Ñˆ ÑÐµÑ€Ð²ÐµÑ€)
   - **Ð£Ñ‡ÐµÑ‚Ð½Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ:** CI84324523-lnx-mon_ci (Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð½Ð° ÑÐ²Ð¾Ð¹ KAE)
   - **ÐžÐ±Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ:** "Ð”Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ vault-agent Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸ÐµÐ¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²"

5. Ð”Ð¾Ð¶Ð´Ð¸Ñ‚ÐµÑÑŒ **ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ñ Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ** Ð¿Ñ€Ð°Ð² (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ 1-2 Ð´Ð½Ñ)

---

### Ð¨Ð°Ð³ 5: Ð Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ `/opt/vault/`

Ð’ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ `install_vault_via_rlm()` (Ñ„Ð°Ð¹Ð» `install-monitoring-stack.sh`):

1. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÑÐµÐºÑ†Ð¸ÑŽ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³Ð¾Ð² `/opt/vault/`
2. Ð Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð±Ð»Ð¾ÐºÐ¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ:
   - `/opt/vault/bin`
   - `/opt/vault/conf`
   - `/opt/vault/log`
   - `/opt/vault/certs`

---

### Ð¨Ð°Ð³ 6: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹

Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Jenkins pipeline **Ð±ÐµÐ· Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð° `RENEW_CERTIFICATES_ONLY`**:

```groovy
pipeline {
    parameters {
        booleanParam(name: 'RENEW_CERTIFICATES_ONLY', defaultValue: false, description: 'Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹')
        // ... Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
    }
}
```

Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ñ‡Ñ‚Ð¾:
- âœ… `RENEW_CERTIFICATES_ONLY` = **false**
- âœ… `SKIP_VAULT_INSTALL` = **false**
- âœ… `SKIP_RPM_INSTALL` = **false** (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²)

---

## ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸

ÐŸÐ¾ÑÐ»Ðµ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:

### 1. Ð¡Ñ‚Ð°Ñ‚ÑƒÑ vault-agent:
```bash
sudo systemctl status vault-agent
```

**ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:**
```
â— vault-agent.service - "HashiCorp Vault - A tool for managing secrets"
     Loaded: loaded (/usr/lib/systemd/system/vault-agent.service; enabled)
     Active: active (running)
```

### 2. ÐÐ°Ð»Ð¸Ñ‡Ð¸Ðµ credentials:
```bash
ls -lah /opt/vault/conf/
```

**ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:**
```
-rw-r----- 1 CI84324523-lnx-va-start CI84324523-lnx-va-read  37 Feb 15 17:14 role_id.txt
-rw-r----- 1 CI84324523-lnx-va-start CI84324523-lnx-va-read  37 Feb 15 17:14 secret_id.txt
-rw-r----- 1 CI84324523-lnx-va-start CI84324523-lnx-va-read 1.2K Feb 15 17:16 agent.hcl
```

### 3. ÐÐ°Ð»Ð¸Ñ‡Ð¸Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²:
```bash
ls -lah /opt/vault/certs/
```

**ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:**
```
-rw-r----- 1 CI84324523-lnx-va-start CI84324523-lnx-va-read 4.5K Feb 15 17:17 server_bundle.pem
-rw-r----- 1 CI84324523-lnx-va-start CI84324523-lnx-va-read 2.1K Feb 15 17:17 ca_chain.crt
-rw-r----- 1 CI84324523-lnx-va-start CI84324523-lnx-va-read 4.5K Feb 15 17:17 grafana-client.pem
```

### 4. Ð›Ð¾Ð³Ð¸ vault-agent:
```bash
sudo journalctl -u vault-agent -n 50 --no-pager
```

**ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ:**
```
[INFO] auth.handler: authentication successful
[INFO] (runner) creating watcher
[INFO] (runner) template rendered
```

---

## ÐžÑ‚ÐºÐ°Ñ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹

Ð•ÑÐ»Ð¸ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ðº ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ð¾Ð¼Ñƒ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ñƒ:

### Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð¾Ñ‚ÐºÐ°Ñ‚:

```bash
# 1. Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· git
git checkout install-monitoring-stack.sh sudoers.example

# 2. Ð˜Ð»Ð¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð¸Ð· backup
cp install-monitoring-stack.sh.backup_dont_change install-monitoring-stack.sh

# 3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ñ ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ‹Ð¼ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¾Ð¼
# Ð’ Jenkins ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ RENEW_CERTIFICATES_ONLY=false
```

### Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ vault-agent (ÐµÑÐ»Ð¸ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½):

```bash
# ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²Ð¸Ñ
sudo systemctl stop vault-agent
sudo systemctl disable vault-agent

# Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»Ñ‹ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
sudo rm -rf /opt/vault/
```

---

## Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¾Ð²

| Ð¥Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ° | Simplified (Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹) | LEGACY (vault-agent) |
|----------------|----------------------|----------------------|
| Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ | Ð˜Ð· Jenkins / self-signed | ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ñ€Ð¾Ñ‚Ð°Ñ†Ð¸Ñ Ð¸Ð· Vault |
| Sudo-Ð¿Ñ€Ð°Ð²Ð° | Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ systemctl --user | Ð¢Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑÑ Ð´Ð»Ñ /opt/vault/ |
| Ð¡Ð»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ | ÐÐ¸Ð·ÐºÐ°Ñ | Ð¡Ñ€ÐµÐ´Ð½ÑÑ |
| Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ | Ð’Ñ‹ÑÐ¾ÐºÐ°Ñ (Ð²ÑÐµ Ð² user-space) | Ð’Ñ‹ÑÐ¾ÐºÐ°Ñ (Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ð¾Ðµ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ) |
| Ð Ð¾Ñ‚Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² | Ð ÑƒÑ‡Ð½Ð°Ñ (Ñ‡ÐµÑ€ÐµÐ· Jenkins job) | ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ |
| Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ | ÐÐµÑ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² | Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ vault-agent |

---

## ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ Ð¸ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°

ÐŸÑ€Ð¸ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ½Ð¾Ð²ÐµÐ½Ð¸Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð²:

1. **ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ:**
   - `CERTIFICATE-RENEWAL.md` â€” Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð°
   - `LEGACY-VAULT-AGENT-SETUP.md` â€” Ð´Ð»Ñ vault-agent Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð°

2. **ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸:**
   - Ð”ÐµÐ¿Ð»Ð¾Ð¹Ð¼ÐµÐ½Ñ‚: `/tmp/monitoring-deployment.log`
   - vault-agent: `sudo journalctl -u vault-agent`

3. **ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ:**
   - IDM/ÐšÐ¸Ð±ÐµÑ€Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ: Ð´Ð»Ñ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ñ sudo-Ð¿Ñ€Ð°Ð²
   - ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ Vault: Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ approle Ð¸ Ð¿ÑƒÑ‚Ð¸ Ð² Vault

---

**ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÐµÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ:** 15.02.2026  
**ÐÐ²Ñ‚Ð¾Ñ€:** Monitoring Stack Automation Team
