# Анализ корневой причины проблемы

## Проблема
Скрипт `install-monitoring-stack.sh` падает сразу после:
```
[INFO] Запуск скрипта (БЕЗ sudo - под CI-пользователем)...
```

## Найденные и исправленные проблемы

### 1. Критическая ошибка: Неправильный shebang
- **Было**: `-#!/bin/bash` (с лишним дефисом)
- **Стало**: `#!/bin/bash`
- **Влияние**: Скрипт не мог корректно интерпретироваться

### 2. Критическая ошибка: Несовместимость с bash 3.x
- **Было**: `${SEC_MAN_ADDR^^}` для преобразования в верхний регистр
- **Стало**: `echo "${SEC_MAN_ADDR}" | tr '[:lower:]' '[:upper:]'`
- **Влияние**: `${VAR^^}` появился в bash 4.0. На серверах с bash 3.x это вызывает синтаксическую ошибку

### 3. Дополнительные исправления:
- Исправлен лишний `EOF` в генерации agent.hcl (строка 2028)
- Добавлена инициализация переменных `SKIP_*`
- Исправлен shebang в backup файле

## Почему проблема проявлялась именно так

### Цепочка событий:
1. **Jenkins запускает скрипт** → `bash install-monitoring-stack.sh`
2. **Интерпретатор читает shebang** → `-#!/bin/bash` (ошибка!)
3. **Или**: Интерпретатор видит `${SEC_MAN_ADDR^^}` → синтаксическая ошибка в bash 3.x
4. **Скрипт падает немедленно** → не выводит даже `[SCRIPT_START]`
5. **В логах только последнее сообщение Jenkins** → `[INFO] Запуск скрипта...`

### Почему не было видно ошибок в логах:
- Синтаксические ошибки в bash выводятся в stderr
- Jenkins может не показывать stderr скрипта в логах пайплайна
- Или ошибка происходит до любого вывода в stderr (`>&2`)

## Проверка исправлений

### 1. Проверка shebang:
```bash
head -1 install-monitoring-stack.sh
# Должно быть: #!/bin/bash
```

### 2. Проверка совместимости с bash 3.x:
```bash
# Ищем проблемные конструкции
grep -n "\^\^" install-monitoring-stack.sh
# Не должно быть результатов
```

### 3. Проверка синтаксиса:
```bash
bash -n install-monitoring-stack.sh
# Не должно быть ошибок
```

### 4. Тестовый запуск первых команд:
```bash
# Создаем тестовый скрипт
head -100 install-monitoring-stack.sh > test.sh
chmod +x test.sh
./test.sh
# Должен вывести [SCRIPT_START] сообщения
```

## Рекомендации для следующего запуска

### Что должно измениться:
1. ✅ Скрипт запустится (исправлен shebang)
2. ✅ Не будет синтаксической ошибки `${VAR^^}` (заменено на `tr`)
3. ✅ Появятся сообщения `[SCRIPT_START]` в логах
4. ✅ Скрипт продолжит выполнение дальше

### Что проверять в логах:
1. **Должны появиться**: `[SCRIPT_START] Script started at ...`
2. **Должны появиться**: `[SCRIPT_START] Running as user: ...`
3. **Должны появиться**: `[SCRIPT_START] PWD: ...`
4. **Если есть**: `[MAIN] START: main() функция запущена` - отлично!

### Если проблема сохраняется:
1. Проверить версию bash на целевом сервере: `bash --version`
2. Проверить права на файл: `ls -la install-monitoring-stack.sh`
3. Проверить кодировку файла (CRLF/LF, BOM)
4. Запустить с отладкой: `bash -x install-monitoring-stack.sh`

## Заключение

**Основная причина**: Несовместимость с bash 3.x из-за использования `${VAR^^}`.

**Вторичная причина**: Поврежденный shebang (`-#!/bin/bash`).

**Исправления**:
1. ✅ Заменен `${VAR^^}` на совместимый `tr`
2. ✅ Исправлен shebang
3. ✅ Исправлены другие синтаксические ошибки

**Ожидаемый результат**: Скрипт теперь должен запускаться и проходить начальные этапы выполнения.